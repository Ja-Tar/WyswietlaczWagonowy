<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Train Display</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        iframe {
            width: 1920px;
            height: 1050px;
            transform-origin: top left;
            border: none;
        }
    </style>
</head>

<body>
    <iframe id="container" frameborder="0"></iframe>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const trainNumber = urlParams.get('train');
        const wagonNumber = urlParams.get('wagon');
        const iframe = document.querySelector('#container'); // Updated to select the iframe by ID

        function resizeIframe() {
            const scale = Math.min(window.innerWidth / 1920, window.innerHeight / 1050);
            iframe.style.width = `${1920 * scale}px`;
            iframe.style.height = `${1050 * scale}px`;
        }

        window.addEventListener('resize', resizeIframe);
        resizeIframe();

        const templateUrl = 'template.html';
        const options = { method: 'GET', headers: { 'Cache-Control': 'public' } };

        /* fetch template.html */
        fetch(templateUrl, options)
            .then(response => response.text())
            .then(data => {
                iframe.contentDocument.open();
                iframe.contentDocument.write(data);
                iframe.contentDocument.close();
            })
            .catch(error => {
                console.error('Error fetching template:', error);
            });

        function setDateAndTime() {
            let dateDiv = iframe.contentDocument.getElementById('date');
            let timeDiv = iframe.contentDocument.getElementById('time');

            let date = new Date();
            let hours = date.getHours();
            let minutes = date.getMinutes();
            let day = date.getDate();
            let month = date.getMonth() + 1;
            let year = date.getFullYear();

            dateDiv.textContent = `${day < 10 ? '0' + day : day}.${month < 10 ? '0' + month : month}.${year}`;
            timeDiv.textContent = `${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}`;
        }

        async function changeValues() {
            if (iframe.contentDocument) {
                iframe.contentDocument.getElementById('carriage_number').textContent = wagonNumber;
                iframe.contentDocument.getElementById('train_name').innerHTML = "";

                let temperatureDiv = iframe.contentDocument.getElementById('temperature');
                let currentSpeedDiv = iframe.contentDocument.getElementById('current_speed');

                temperatureDiv.textContent = '--Â°C';
                currentSpeedDiv.textContent = '-- km/h';

                let error = false;

                const url = 'https://api.td2.info.pl/?method=getTrainsOnline';
                const options = { method: 'GET' };
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    console.log(data.message.length);
                    if (data.message.length > 0) {
                        const train = data.message.find(train => train.trainNo === parseInt(trainNumber));
                        if (train) {
                            iframe.contentDocument.getElementById('train_name').textContent = trainNumber;
                        } else {
                            console.error('Train not found');
                            error = true;
                        }
                    } else {
                        console.error('Train not found');
                        error = true;
                    }
                } catch (fetchError) {
                    console.error(fetchError);
                    error = true;
                }

                if (error) {
                    iframe.contentDocument.getElementById('main_display').style.visibility = 'hidden';
                    iframe.contentDocument.getElementById('loader_box').style.display = 'none';
                    iframe.contentDocument.getElementById('error_box').style.display = 'flex';
                } else {
                    iframe.contentDocument.getElementById('main_display').style.visibility = 'visible';
                    iframe.contentDocument.getElementById('loader_box').style.display = 'none';

                    iframe.contentWindow.scrollText();
                    iframe.contentWindow.dynamicWrapText('route_box');
                }
            } else {
                console.error('iframe.contentDocument is not available yet');
            }
        }

        iframe.onload = changeValues; 
        setInterval(setDateAndTime, 1000);
    </script>
</body>

</html>