<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Wyświetlacz Wagonowy TD2</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        iframe {
            width: 1920px;
            height: 1050px;
            transform-origin: top left;
            border: none;
        }
    </style>
</head>

<body>
    <iframe id="container" frameborder="0"></iframe>
    <script src="train_name.js" module></script>
    <script>
        // Change version on API update
        const apiVersion = '1';

        const urlParams = new URLSearchParams(window.location.search);
        const trainNumber = urlParams.get('train');
        const wagonNumber = urlParams.get('wagon');
        const displayType = urlParams.get('type');
        const iframe = document.querySelector('#container');

        function resizeIframe() {
            const scale = Math.min(window.innerWidth / 1920, window.innerHeight / 1050);
            iframe.style.width = `${1920 * scale}px`;
            iframe.style.height = `${1050 * scale}px`;
        }

        window.addEventListener('resize', resizeIframe);
        resizeIframe();

        const templateUrl = 'template.html';
        const options = { method: 'GET', headers: { 'Cache-Control': 'public' } };

        /* fetch template.html */
        fetch(templateUrl, options)
            .then(response => response.text())
            .then(data => {
                iframe.contentDocument.open();
                iframe.contentDocument.write(data);
                iframe.contentDocument.close();
            })
            .catch(error => {
                console.error('Error fetching template:', error);
            });

        function setDateAndTime() {
            let dateDiv = iframe.contentDocument.getElementById('date');
            let minDiv = iframe.contentDocument.getElementById('min');
            let colonDiv = iframe.contentDocument.getElementById('colon');
            let secDiv = iframe.contentDocument.getElementById('sec');

            let date = new Date();
            let hours = date.getHours();
            let minutes = date.getMinutes();
            let day = date.getDate();
            let month = date.getMonth() + 1;
            let year = date.getFullYear();

            dateDiv.textContent = `${day < 10 ? '0' + day : day}.${month < 10 ? '0' + month : month}.${year}`;
            minDiv.textContent = `${hours < 10 ? '0' + hours : hours}`;
            secDiv.textContent = `${minutes < 10 ? '0' + minutes : minutes}`;
            if (colonDiv.style.visibility === 'visible') {
                colonDiv.style.visibility = 'hidden';
            } else {
                colonDiv.style.visibility = 'visible';
            }
        }

        async function setTemperature() {
            let temperatureDiv = iframe.contentDocument.getElementById('temperature');

            let url = 'https://api.td2.info.pl/?method=getWeather';

            const options = { method: 'GET' };
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                if (data.success) {
                    let temperature = data.message.main.temp; // temperature in Kelvin
                    temperature = Math.round(temperature - 273.15); // convert to Celsius
                    temperatureDiv.textContent = `${temperature}°C`;
                } else {
                    console.error('Error fetching weather data');
                }
            } catch (fetchError) {
                console.error(fetchError);
                temperatureDiv.textContent = '--°C';
            }
        }

        async function setDataFromStacjownik() {
            let currentSpeedDiv = iframe.contentDocument.getElementById('current_speed');

            let url = "https://stacjownik.spythere.eu/api/getActiveTrainList";

            const options = { method: 'GET' };
            try {
                //throw new Error('An error has occurred'); 
                const response = await fetch(url, options);
                const data = await response.json();

                if (data.length > 0) {
                    let train = data.find(train => train.trainNo === parseInt(trainNumber));
                    if (train) {
                        if (train.stockString === '') {
                            console.log()
                        }
                        console.log('Stock string:', train.stockString);

                        let speed = train.speed;
                        currentSpeedDiv.textContent = `${speed} km/h`;

                        let trainNameString = getTrainName(trainNumber, train.stockString, train.timetable.category);
                        iframe.contentDocument.getElementById('train_name').textContent = trainNameString;
                        document.title = `Wagon ${wagonNumber} - ${trainNameString}`;

                        let route = train.timetable.route.split('|'); // before split: DOBRZYNIEC|Wielichowo Główne
                        route = route.map(station => station.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '));
                        iframe.contentDocument.getElementById('route_box').textContent = route.join(' - ');

                        setRouteStations(train.timetable.stopList); // Pass correct stopPoints to the setRouteStations function
                        return true;
                    } else {
                        console.error('Train not found');
                        return false;
                    }
                } else {
                    console.error('No active trains found');
                    return false;
                }
            } catch (fetchError) {
                if (fetchError instanceof TypeError) {
                    console.error('[Train timetable not found]:', fetchError);
                } else {
                    console.error('Fetch error occurred:', fetchError); // Log other errors
                }
                return false;
            }
        }

        function formatStopsName(stopPoints) {
            stopPoints.forEach(stopPoint => {
                let formattedStopName = stopPoint.stopNameRAW;
                formattedStopName = formattedStopName.split(',');
                let stopNameType = formattedStopName[1];
                if (!stopNameType) {
                    stopNameType = '';
                }
                formattedStopName = formattedStopName[0].toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                stopPoint.stopNameRAW = formattedStopName;
                stopPoint.stopNameType = stopNameType.trim();
            });
            return stopPoints;
        }

        function setRouteStations(stopPoints) {
            let nextStopsList = [];

            stopPoints.forEach(stopPoint => {
                if (stopPoint.confirmed === 0) {
                    nextStopsList.push(stopPoint);
                }
            });

            nextStopsList = nextStopsList.filter(stopPoint => stopPoint.stopType === 'ph' || stopPoint.beginsHere === true || stopPoint.terminatesHere === true);

            nextStopsList = formatStopsName(nextStopsList);

            nextStopsList.forEach(stopPoint => {
                if (stopPoint.stopNameType === 'po') {
                    /* check if stop has been passed (stop without confirmed arrival) */
                    let departureTime = stopPoint.departureRealTimestamp;
                    let currentTime = new Date().getTime();
                    if (currentTime > departureTime) {
                        /* remove stop from the list */
                        let index = nextStopsList.indexOf(stopPoint);
                        if (index > -1) {
                            nextStopsList.splice(index, 1);
                        }
                    }
                }
            });

            // get first next stop
            if (nextStopsList.length > 0) {
                let restStationsDiv = iframe.contentDocument.getElementById('rest_stations');
                const nextStation = iframe.contentDocument.getElementById('next_station');
                const nextStationDelay = iframe.contentDocument.getElementById('next_station_delay');
                const oldDelayTime = iframe.contentDocument.getElementById('old_time');
                const newDelayTime = iframe.contentDocument.getElementById('new_time');
                const nextStationDelayName = iframe.contentDocument.getElementById('next_station_delay_name');

                let firstNextStop = nextStopsList[0];
                //console.log('First next stop:', firstNextStop); 
                let departureTime = firstNextStop.arrivalTimestamp;
                let departureDelay = firstNextStop.arrivalDelay;
                let realDepartureTime = firstNextStop.arrivalRealTimestamp;
                if (firstNextStop.beginsHere === true) {
                    departureTime = firstNextStop.departureTimestamp;
                    departureDelay = firstNextStop.departureDelay;
                    realDepartureTime = firstNextStop.departureRealTimestamp;
                    restStationsDiv.innerHTML = '';
                }

                departureTime = new Date(departureTime);
                departureTime = departureTime.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

                realDepartureTime = new Date(realDepartureTime);
                realDepartureTime = realDepartureTime.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

                nextStation.textContent = `${departureTime} ${firstNextStop.stopNameRAW}`;
                oldDelayTime.innerHTML = `<del>${departureTime}</del> (+${departureDelay})`;
                newDelayTime.textContent = `${realDepartureTime}`;
                nextStationDelayName.textContent = `${firstNextStop.stopNameRAW}`;

                if (departureDelay > 3 && displayType === 'delay') {
                    nextStationDelay.style.display = '';
                    nextStationDelay.classList.add('currently_displayed');
                    nextStation.style.display = 'none';
                    nextStation.classList.remove('currently_displayed');
                } else {
                    nextStationDelay.style.display = 'none';
                    nextStationDelay.classList.remove('currently_displayed');
                    nextStation.style.display = '';
                    nextStation.classList.add('currently_displayed');
                }

                let stationOverflow = false;

                if (nextStopsList.length > 5) {
                    console.warn('Wykryto więcej niż 5 przystanków na trasie');
                    // TODO: Dodać możliwość zmiany maksymalnej ilości + czy wyświetlać tylko główne stacje
                    nextStopsList = nextStopsList.slice(0, 5);
                    stationOverflow = true;
                }

                if (nextStopsList.length > 1) {
                    restStationsDiv.innerHTML = '';

                    let restStations = nextStopsList.slice(1);

                    restStations.forEach((stopPoint, index) => {
                        let stopTime = stopPoint.arrivalTimestamp;
                        if (stopPoint.beginsHere === true) {
                            stopTime = stopPoint.departureTimestamp;
                        }
                        stopTime = new Date(stopTime);
                        stopTime = stopTime.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                        let stopName = stopPoint.stopNameRAW;
                        //stopName = stopName.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                        let stopElement = document.createElement('span');
                        stopElement.textContent = `${stopTime} ${stopName}` + (index < restStations.length - 1 ? ', ' : ''); // : stationOverflow ? '...' : '');
                        restStationsDiv.appendChild(stopElement);
                    });

                } else {
                    restStationsDiv.innerHTML = '';
                }
            }

            //console.log(nextStopsList);
        }

        async function changeValues() {
            nextStationDelay = iframe.contentDocument.getElementById('next_station_delay');
            nextStation = iframe.contentDocument.getElementById('next_station');

            //if (displayType === 'delay') {
            //    nextStationDelay.style.display = '';
            //    nextStationDelay.classList.add('currently_displayed');
            //    nextStation.style.display = 'none';
            //    nextStation.classList.remove('currently_displayed');
            //}

            if (!trainNumber || !wagonNumber) {
                iframe.contentDocument.getElementById('main_display').style.visibility = 'visible';
                iframe.contentDocument.getElementById('loader_box').style.display = 'none';
                //iframe.contentDocument.getElementById('error_box').style.display = 'flex';

                if (iframe.contentDocument.getElementById('route_box').childElementCount === 0) {
                    console.error('Train or wagon number not provided - displaying template only');
                    applyResponsiveStyles();
                    window.addEventListener('resize', iframe.contentWindow.overflowRestStations);
                }

                console.log('Update display with template only');

                return;
            }

            if (iframe.contentDocument) {
                await getAPIsForTrainName(apiVersion);
                iframe.contentDocument.getElementById('carriage_number').textContent = wagonNumber;

                let success = false;

                try {
                    success = await setDataFromStacjownik();
                } catch (error) {
                    console.error('Error fetching train data:', error);
                }

                if (!success) {
                    iframe.contentDocument.getElementById('main_display').style.visibility = 'hidden';
                    iframe.contentDocument.getElementById('loader_box').style.display = 'none';
                    iframe.contentDocument.getElementById('error_box').style.display = 'flex';
                } else {
                    iframe.contentDocument.getElementById('main_display').style.visibility = 'visible';
                    iframe.contentDocument.getElementById('loader_box').style.display = 'none';

                    applyResponsiveStyles();
                }
            } else {
                console.error('iframe.contentDocument is not available yet');
            }
        }

        function applyResponsiveStyles() {
            iframe.contentWindow.scrollText();
            if (iframe.contentDocument.getElementById('route_box').childElementCount === 0) {
                iframe.contentWindow.dynamicWrapText('route_box');
            }
            iframe.contentWindow.overflowRestStations();
        }

        iframe.onload = function () {
            changeValues();
            setTemperature();
        }

        setInterval(setDateAndTime, 1000); // 1 second
        setInterval(setTemperature, 600000); // 10 minutes
        setInterval(changeValues, 15000); // 15 seconds
        window.addEventListener('resize', applyResponsiveStyles);
    </script>
</body>

</html>